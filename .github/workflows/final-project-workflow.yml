
name: Final project tests

on:
  push:
    branches: [main, final_project]
  pull_request:
    branches: [main, final_project]
  workflow_dispatch:
    inputs:
      scope:
        description: 'Ð©Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸: api | ui | all'
        type: choice
        options:
        - all
        - api
        - ui
        default: 'all'

permissions:
  contents: write
  checks: write
  pull-requests: write
  actions: read
  pages: write
  id-token: write

env:
  NODE_VERSION: '24.x'
  BUILD_FOLDER: ./final_project/ui_tests

  # API secrets
  API_FOR_HELP_BASE_URL_API: ${{ secrets.API_FOR_HELP_BASE_URL_API }}
  AUTH_URL:             ${{ secrets.AUTH_URL }}
  AUTH_EMAIL:           ${{ secrets.API_FOR_HELP_EMAIL }}
  AUTH_PASSWORD:        ${{ secrets.API_FOR_HELP_PASSWORD }}
  API_DOMAIN:           ${{ secrets.API_DOMAIN }}

  # UI secrets
  API_FOR_HELP_BASE_URL: ${{ secrets.API_FOR_HELP_BASE_URL }}
  API_FOR_HELP_EMAIL:    ${{ secrets.API_FOR_HELP_EMAIL }}
  API_FOR_HELP_PASSWORD: ${{ secrets.API_FOR_HELP_PASSWORD }}

# -----------------------------
# 1) API TESTS (Vitest + Allure)
# -----------------------------
jobs:
  api_test:
    name: Run API (Vitest) Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Ð’Ð¸ÐºÐ¾Ð½ÑƒÑ”Ð¼Ð¾ ÑÐºÑ‰Ð¾ ÐÐ• Ð¾Ð±Ñ€Ð°Ð½Ð¾ Ñ‡Ð¸ÑÑ‚Ð¾ UI (Ñ‚Ð¾Ð±Ñ‚Ð¾ push/PR, Ð°Ð±Ð¾ dispatch Ð· all/api)
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.scope != 'ui' }}
    env:
      BUILD_FOLDER: ./final_project/api_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BUILD_FOLDER }}/package-lock.json

      - name: Install dependencies (API)
        run: npm ci
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Install Playwright browsers (chromium)
        run: npx playwright install --with-deps chromium
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Run Vitest (API)
        id: run_api_tests
        working-directory: ${{ env.BUILD_FOLDER }}
        run: |
          npx vitest run
        continue-on-error: true

      - name: Upload Allure results (API)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: api-allure-results
          path: ${{ env.BUILD_FOLDER }}/allure-results/
          retention-days: 30

      - name: Fail job if API tests failed
        if: steps.run_api_tests.outcome == 'failure'
        run: exit 1

  api_report:
    name: Generate API Allure Report
    runs-on: ubuntu-latest
    needs: [api_test]
    if: ${{ (github.event_name != 'workflow_dispatch' || inputs.scope != 'ui') && always() }}
    env:
      BUILD_FOLDER: ./final_project/api_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: final_project/api_tests/package-lock.json

      - name: Install dependencies (API)
        run: npm ci
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Download Allure results (API)
        uses: actions/download-artifact@v4
        with:
          name: api-allure-results
          path: ${{ env.BUILD_FOLDER }}/allure-results

      - name: Generate Allure report (API)
        run: |
          npx allure generate allure-results -o allure-report --clean
          echo "Allure API report generated successfully"
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Generate Allure single-file (API)
        run: |
          npx allure generate allure-results --single-file --clean -o allure-report-single-file
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Upload Allure report artifact (API)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-allure-report
          path: ${{ env.BUILD_FOLDER }}/allure-report/
          retention-days: 30

      - name: Upload Allure single-file artifact (API)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-allure-report-single-file
          path: ${{ env.BUILD_FOLDER }}/allure-report-single-file/
          retention-days: 30

  # -----------------------------
  # 2) UI TESTS (Playwright + Allure) â€” Ð¿Ñ–ÑÐ»Ñ API Ð´Ð»Ñ scope=all
  # -----------------------------
  ui_test_after_api:
    name: Run UI (Playwright) Tests [after API]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [api_test]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.scope == 'all' && needs.api_test.result == 'success' }}
    env:
      BUILD_FOLDER: ./final_project/ui_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BUILD_FOLDER }}/package-lock.json

      - name: Install dependencies (UI)
        run: npm ci
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Install Playwright browsers (chromium)
        run: npx playwright install --with-deps chromium
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Run Playwright tests (UI)
        id: run_ui_tests_after_api
        working-directory: ${{ env.BUILD_FOLDER }}
        run: |
          npx playwright test
        continue-on-error: true

      - name: Upload Allure results (UI)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: ui-allure-results
          path: ${{ env.BUILD_FOLDER }}/allure-results/
          retention-days: 30

      - name: Fail job if UI tests failed
        if: steps.run_ui_tests_after_api.outcome == 'failure'
        run: exit 1

  ui_report_after_api:
    name: Generate UI Allure Report [after API]
    runs-on: ubuntu-latest
    needs: [ui_test_after_api]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.scope == 'all' && always() }}
    env:
      BUILD_FOLDER: ./final_project/ui_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: final_project/ui_tests/package-lock.json

      - name: Install dependencies (UI)
        run: npm ci
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Download Allure results (UI)
        uses: actions/download-artifact@v4
        with:
          name: ui-allure-results
          path: ${{ env.BUILD_FOLDER }}/allure-results

      - name: Generate Allure report (UI)
        run: |
          npx allure generate allure-results -o allure-report --clean
          echo "Allure UI report generated successfully"
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Generate Allure single-file (UI)
        run: |
          npx allure generate allure-results --single-file --clean -o allure-report-single-file
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Upload Allure report artifact (UI)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-allure-report
          path: ${{ env.BUILD_FOLDER }}/allure-report/
          retention-days: 30

      - name: Upload Allure single-file artifact (UI)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-allure-report-single-file
          path: ${{ env.BUILD_FOLDER }}/allure-report-single-file/
          retention-days: 30

  # -----------------------------
  # 2.2) UI Ð½Ð°Ð¿Ñ€ÑÐ¼Ñƒ (Ð´Ð»Ñ scope=ui)
  # -----------------------------
  ui_test_direct:
    name: Run UI (Playwright) Tests [direct]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.scope == 'ui' }}
    env:
      BUILD_FOLDER: ./final_project/ui_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BUILD_FOLDER }}/package-lock.json

      - name: Install dependencies (UI)
        run: npm ci
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Install Playwright browsers (chromium)
        run: npx playwright install --with-deps chromium
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Run Playwright tests (UI)
        id: run_ui_tests_direct
        working-directory: ${{ env.BUILD_FOLDER }}
        run: |
          npx playwright test
        continue-on-error: true

      - name: Upload Allure results (UI)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: ui-allure-results
          path: ${{ env.BUILD_FOLDER }}/allure-results/
          retention-days: 30

      - name: Fail job if UI tests failed
        if: steps.run_ui_tests_direct.outcome == 'failure'
        run: exit 1

  ui_report_direct:
    name: Generate UI Allure Report [direct]
    runs-on: ubuntu-latest
    needs: [ui_test_direct]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.scope == 'ui' && always() }}
    env:
      BUILD_FOLDER: ./final_project/ui_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: final_project/ui_tests/package-lock.json

      - name: Install dependencies (UI)
        run: npm ci
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Download Allure results (UI)
        uses: actions/download-artifact@v4
        with:
          name: ui-allure-results
          path: ${{ env.BUILD_FOLDER }}/allure-results

      - name: Generate Allure report (UI)
        run: |
          npx allure generate allure-results -o allure-report --clean
          echo "Allure UI report generated successfully"
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Generate Allure single-file (UI)
        run: |
          npx allure generate allure-results --single-file --clean -o allure-report-single-file
        working-directory: ${{ env.BUILD_FOLDER }}

      - name: Upload Allure report artifact (UI)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-allure-report
          path: ${{ env.BUILD_FOLDER }}/allure-report/
          retention-days: 30

      - name: Upload Allure single-file artifact (UI)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-allure-report-single-file
          path: ${{ env.BUILD_FOLDER }}/allure-report-single-file/
          retention-days: 30

  # -----------------------------
  # 3) ÐŸÑƒÐ±Ð»Ñ–ÐºÐ°Ñ†Ñ–Ñ Ð½Ð° GitHub Pages (Ð¾Ð±â€™Ñ”Ð´Ð½Ð°Ð½Ð¾ API + UI)
  # -----------------------------
  publish_pages:
    name: Publish Allure Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs:
      - api_report
      - ui_report_after_api
      - ui_report_direct
    if: ${{ always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/final_project') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout existing GitHub Pages branch (if present)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Download API Allure report artifact
        uses: actions/download-artifact@v4
        with:
          name: api-allure-report
          path: ./tmp/api-allure-report
        continue-on-error: true

      - name: Download UI Allure report artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-allure-report
          path: ./tmp/ui-allure-report
        continue-on-error: true

      - name: Prepare Allure report for Pages (merge API/UI)
        run: |
          mkdir -p gh-pages/${{ github.run_number }}/api
          mkdir -p gh-pages/${{ github.run_number }}/ui

          if [ -d "./tmp/api-allure-report" ]; then
            cp -r ./tmp/api-allure-report/* gh-pages/${{ github.run_number }}/api/
          fi
          if [ -d "./tmp/ui-allure-report" ]; then
            cp -r ./tmp/ui-allure-report/* gh-pages/${{ github.run_number }}/ui/
          fi

          find gh-pages -maxdepth 1 -type d -printf '%f\n' | grep -E '^[0-9]+$' | sort -rn > gh-pages/builds.txt

          cat > gh-pages/builds.html << 'HTML_HEAD'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Allure Test Reports - All Builds</title>
            <style>
              body { font-family:Arial, sans-serif; max-width:900px; margin:50px auto; padding:20px; }
              h1 { color: #333; }
              ul { list-style:none; padding:0;}
              li { margin:10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
              a { color: #0066cc; text-decoration: none; font-weight: bold; }
              a:hover { text-decoration: underline; }
              .latest { background: #e3f2fd; border: 2px solid #2196f3; }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š Allure Test Reports - All Builds</h1>
            <p>Available reports by build number:</p>
            <ul>
          HTML_HEAD

          FIRST=1
          while read -r BUILD; do
            if [ "$FIRST" -eq 1 ]; then
              echo "  <li class=\"latest\">Build #${BUILD}: <a href=\"./${BUILD}/api/\">API</a> | <a href=\"./${BUILD}/ui/\">UI</a> (Latest)</li>" >> gh-pages/builds.html
              FIRST=0
            else
              echo "  <li>Build #${BUILD}: <a href=\"./${BUILD}/api/\">API</a> | <a href=\"./${BUILD}/ui/\">UI</a></li>" >> gh-pages/builds.html
            fi
          done < gh-pages/builds.txt

          cat >> gh-pages/builds.html << 'HTML_TAIL'
            </ul>
          </body>
          </html>
          HTML_TAIL

      - name: Deploy to GitHub Pages
        id: gh-pages-deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: true
          destination_dir: ./

      - name: Add Allure report link to summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Allure Report (GitHub Pages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Latest Build #${{ github.run_number }}**:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— API: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/api/" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— UI : https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/ui/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/builds.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: Pages Ð¼Ð¾Ð¶Ðµ Ð¾Ð½Ð¾Ð²Ð»ÑŽÐ²Ð°Ñ‚Ð¸ÑÑ Ð´Ð¾ 1-2 Ñ…Ð². Ð¯ÐºÑ‰Ð¾ Ð±Ð°Ñ‡Ð¸Ñˆ 404 â€” Ð·Ð°Ñ‡ÐµÐºÐ°Ð¹ Ñ– Ð¿ÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶." >> $GITHUB_STEP_SUMMARY
